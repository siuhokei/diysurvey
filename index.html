<!doctype html>
<html>

<head>
	<title>眾樂樂不如獨樂樂 - 自慰習慣及心態調查結果</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
	<link rel="stylesheet" href="css/style.css" />
	<link rel="stylesheet" href="https://cdn.datatables.net/1.10.13/css/jquery.dataTables.min.css" />
	<script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
	<script src="https://d3js.org/d3.v4.min.js"></script>
	<script src="https://cdn.datatables.net/1.10.13/js/jquery.dataTables.min.js"></script>
	<script>
		d3.csv("js/test.csv", function(error, source) {
			if (error) throw error;

			$(function() {
				$("#questions").val("q1");
				parseQuestions("q1");
			});

			$("#questions").change(function() {
				$("#gender").val("全部");
				$("#age").val("全部");
				parseQuestions($("#questions").val());
			});

			$("#gender").change(function() {
				parseQuestions($("#questions").val());
			})

			$("#age").change(function() {
				parseQuestions($("#questions").val());
			})

			function parseQuestions(number) {
				var name = $("#questions option:selected").text();

				if (number != "")
					switch (number) {
						case "q1":
							$("#gender").prop("disabled", "disabled");
							$("#age").prop("disabled", false);
							createChart(number, name, false, true);
							break;
						case "q2":
							$("#gender").prop("disabled", false);
							$("#age").prop("disabled", "disabled");
							createChart(number, name, true, false);
							break;
						case "q3":
						case "q4":
						case "q5":
						case "q6":
						case "q7":
						case "q8":
						case "q9":
						case "q10":
						case "q11":
						case "q12":
						case "q13":
						case "q14":
						case "q15":
							$("#gender").prop("disabled", false);
							$("#age").prop("disabled", false);
							createChart(number, name, true, true);
							break;
					}
			}

			function createChart(question, name, isGender, isAge) {
				var result = [],
					data = [],
					qnum = question.match(/\d+/)[0],
					attribute = "d." + question,
					genderFilter = (isGender) ? $("#gender").val() : "全部",
					ageFilter = (isAge)? $("#age").val() : "全部";

				if (question != "") {
					if (qnum >= 4 && qnum <= 12) {
						$.each(source, function(i, d) {
							if (d.q3 == "有")
								data.push(d);
						});
					} 
					else data = source;

					$.each(data, function(i, d) {
						if (d.q1 == genderFilter && d.q2 == ageFilter)
							result.push(eval(attribute));
						else if (d.q1 == genderFilter && ageFilter == "全部")
							result.push(eval(attribute));
						else if (genderFilter == "全部" && d.q2 == ageFilter)
							result.push(eval(attribute));
						else if (genderFilter == "全部" && ageFilter == "全部")
							result.push(eval(attribute));
					});
				}

				if (qnum == 6 || qnum == 8 || qnum == 10) {
					var temp = [];

					$.each(result, function(i, d) {
						d = d.replace("，", ", ");
						$.each(d.split(", "), function(i, d) {
							temp.push(d)
						})
					});

					result = temp;

					if (result.length > 0) {
						showTable(getCounts(result));
						/*drawBarChart({
							titleText: name,
							subtitleText: "",
							data: getCounts(result),
							size: data.length
						});*/
					}
				}
				else if (result.length > 0) {
					showTable(getCounts(result));
					/*drawPieChart({
						titleText: name,
						subtitleText: "",
						data: getCounts(result)
					});*/
				}
				else {
					$("#details").empty();
					$("#details").DataTable({
						"info": false
					});
					$("#message").html("沒有數據。");
				}
			}

			function getCounts(data) {
				var counts = {};
				var arr = [];

				$.each(data, function(i, d) {
					counts[d] = (counts[d] || 0) + 1;
				});

				$.each(Object.keys(counts), function(i, d) {
					arr.push({
						label: d,
						value: counts[d],
						percentage: (counts[d] / data.length * 100).toFixed(2)
					});
				});

				return arr;
			}

			function showTable(data) {
				$("#message").empty();
				$("#details").DataTable({
					"data": data,
					"paging": false,
					"searching": false,
					"destroy": true,
					"columns": [{
						"data": "label",
						"title": "選擇"
					}, {
						"data": "value",
						"title": "數目"
					}, {
						"data": "percentage",
						"title": "百分比"
					}],
					"order": [
						[1, "dsc"]
					]
				});
			}

		});
	</script>
</head>
<body>
	<div id="intro">
		<h1>眾樂樂不如獨樂樂 - 自慰習慣及心態調查結果</h1>
		<p>2013年的時候廣州中山大學做了一個有關自慰的調查：<br/>
		<a href="http://www.ettoday.net/news/20130619/226025.htm" target="_blank">廣東中山大學自慰調查：四成女大生「一年沒幾次」</a></p>
		<p>他們又弄了個短片比賽，學生在大學校園訪問學生有關自慰的種種。</p>
		<p>正經做過的自慰調查真的不多，多見到的是其他討論區那些自行設立的調查。不如自己照中山大學的問卷依樣畫葫蘆吧，就有了這個問卷。</p>
		<p>如果大家不介意做做看，請到<a href="http://bit.ly/14Tb7Ns" target="_blank">這裡</a>。</p>
	</div>
	<div id="controls">
		<label for="questions">請選擇問題：</label>
		<select id="questions">
			<option value="q1" selected>你是男生還是女生？</option>
			<option value="q2">你現在幾歲？</option>
			<option value="q3">你有沒有自慰過？</option>
			<option value="q4">自慰的頻率是多少？</option>
			<option value="q5">最近一次自慰的時間是？</option>
			<option value="q6">你通常在那兒自慰？</option>
			<option value="q7">你有否試過給其他人撞破過？</option>
			<option value="q8">你通常用甚麼自慰？</option>
			<option value="q9">自慰時有沒有性幻想的對象？</option>
			<option value="q10">如果你有性幻想的對象，那個對象通常是？</option>
			<option value="q11">你是怎樣懂得自慰呢？</option>
			<option value="q12">你認識的人是否知道你會自慰？</option>
			<option value="q13">你怎樣看自慰這行為？</option>
			<option value="q14">你有伴侶嗎？</option>
			<option value="q15">如果你的伴侶會自慰，你會怎樣看？</option>
		</select>
	</div>
	<div id="filters">
		<label for="gender">請選擇性別：</label>
		<select id="gender">
			<option value="全部" selected>全部</option>
			<option value="男生">男生</option>
			<option value="女生">女生</option>
		</select>
		<br/>
		<label for="age">請選擇年齡：</label>
		<select id="age">
			<option value="全部" selected>全部</option>
			<option value="10 - 14">10-14歲</option>
			<option value="15 - 19">15-19歲</option>
			<option value="20 - 24">20-24歲</option>
			<option value="25 - 29">25-29歲</option>
			<option value="30 - 34">30-34歲</option>
			<option value="35 - 39">35-39歲</option>
			<option value="40 - 44">40-44歲</option>
			<option value="45 - 49">45-49歲</option>
			<option value="50 - 54">50-54歲</option>
			<option value="55 - 59">55-59歲</option>
			<option value="60 - 64">60-64歲</option>
			<option value="大過64歲">大過64歲</option>
		</select>
	</div>
	<div id="result">
		<table id="details" class="display compact stripe" width="100%"></table>
		<div id="message"></div>
	</div>
</body>
</html>